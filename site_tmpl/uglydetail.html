{% extends 'base_admin.html' %}
{% load markdown_deux_tags %}
{% load permissionif %}
{% load gpa_scale_emoji %}
{% load spotify_tags %}

{% block title %}{{event}} | Lens and Lights at WPI{% endblock %}
{% block content %}
    <div class="jumbotron">
        <div class="clearfix">
            <h1>
                {% if event.glyphicon %}
                    <span class="glyphicon glyphicon-{{ event.glyphicon }} jumboglyph" aria-hidden="true"></span>
                {% endif %}
                {{ event }}
            </h1>
        </div>
        <div class="actions pull-right">
            <h3>Status: <b>{{ event.status }}</b></h3>

            <div class="btn-group">
                {% permission request.user has 'events.view_event_reports' of event %}
                    <a class="btn btn-info btn-lg" href="{% url "events:pdf" event.id %}">PDF</a>
                {% endpermission %}
                <!--{% if request.user.is_lnl %}
                    <a class="btn btn-info btn-lg" target="_blank" href="https://wpi0.sharepoint.com/sites/gr-lnl/Event%20Photos/Forms/Thumbnails.aspx?view=7&q={{ event.event_name|urlencode }}">Photos</a>
                {% endif %}-->
                {% if event.reference_code %}
                        <tr>
                            <a class="btn btn-primary btn-lg" target="_blank" href="https://25live.collegenet.com/pro/wpi#!/home/event/{{ event.event_id }}/details">25Live</a>
                        </tr>
                {% endif %}
                {% permission request.user has 'events.add_raw_event' %}
                    <a class="btn btn-success btn-lg"
                       href="{% url "events:duplicate" event.id %}">Duplicate</a>
                {% endpermission %}
                {% if event.closed %}
                    {% permission request.user has 'events.reopen_event' of event %}
                        <a class="btn btn-default btn-lg" href="#reopenModal" role="button"
                           data-toggle="modal">Reopen</a>
                    {% endpermission %}
                {% else %}
                    {% permission request.user has 'events.edit_event_text' of event or request.user has 'events.edit_event_times' of event %}
                        <a class="btn btn-warning btn-lg"
                           href="{% url "events:edit" event.id %}">Edit</a>
                    {% endpermission %}
                    {% if not event.cancelled %}
                        {% if not event.reviewed %}
                            {% permission request.user has 'events.cancel_event' of event %}
                                <a class="btn btn-danger btn-lg" href="#cancelModal" role="button"
                                   data-toggle="modal">Cancel</a>
                            {% endpermission %}
                        {% endif %}
                        {% if not event.approved %}
                            {% permission request.user has 'events.approve_event' of event %}
                                <a class="btn btn-success btn-lg"
                                   href="{% url "events:approve" event.id %}">Approve</a>
                                <a class="btn btn-danger btn-lg"
                                   href="{% url "events:deny" event.id %}">Deny</a>
                            {% endpermission %}
                        {% elif not event.reviewed %}
                            {% permission request.user has 'events.review_event' of event %}
                                <a class="btn btn-success btn-lg"
                                   href="{% url "events:review" event.id %}">Review For Billing	</a>
                            {% endpermission %}
                        {% else %}
                            {% permission request.user has 'events.bill_event' of event %}
                                <a class="btn btn-primary btn-lg"
                                   href="{% url "events:bills:new" event.id %}">Create Bill</a>
                            {% endpermission %}
                        {% endif %}
                    {% endif %}
                    {% if event.cancelled or event.approved and event.reviewed %}
                        {% permission request.user has 'events.close_event' of event %}
                            <a class="btn btn-success btn-lg" href="#closeModal" role="button"
                               data-toggle="modal">Close</a>
                        {% endpermission %}
                    {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="jumbo-event-info">
            <h3>Client{% if event.org.count > 1 %}s{% endif %}:
                {% for org in event.org.all %}
                    {% if org.delinquent %}
                        <a href="{% url "orgs:detail" org.id %}">
                            <span style='color:red'>{{ org.retname }}
                                <span class="glyphicon glyphicon-exclamation-sign" title="Delinquent client"></span>
                            </span>
                        </a>&nbsp;
                    {% else %}
                        <a href="{% url "orgs:detail" org.id %}">{{ org.retname }}</a>&nbsp;
                    {% endif %}
                {% empty %}[None listed]{% endfor %}</h3>
        </div>
    </div>
    {% permission request.user has 'events.close_event' of event %}
    <!-- CloseModal -->
    <div id="closeModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="closeModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="closeModalLabel">Confirm Close Event</h3>
                </div>
                <div class="modal-body">
                    <p>Closing will lock the event for edits, and cannot be easily undone.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Go Back</button>
                    <form class="form-inline" action="{% url 'events:close' event.id %}" method="post">
                        {% csrf_token %}
                        <button class="btn btn-primary" type="submit">Close Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endpermission %}

    {% permission request.user has 'events.cancel_event' of event %}
    <!-- CancelModal -->
    <div id="cancelModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="cancelModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="cancelModalLabel">Confirm Cancel Event</h3>
                </div>
                <div class="modal-body">
                    <p>Cancelling an event cannot be easily undone. This should
                        only be used if an event does not actually occur, and this information was given before any
                        setups/rentals were done.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" style="float:left" data-dismiss="modal" aria-hidden="true">Go Back</button>
                    <form class="form-inline" action="{% url 'events:cancel' event.id %}" method="post">
                        {% csrf_token %}
                        <input type="checkbox" name="notify" id="notify" /> <label for="notify">Notify event contact via email</label>
                        <button class="btn btn-primary" type="submit" style="margin-left: 12px;">Cancel Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endpermission %}

    {% permission request.user has 'events.reopen_event' of event %}
    <!-- ReopenModal -->
    <div id="reopenModal" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="reopenModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                    <h3 id="reopenModalLabel">Confirm Reopen Event</h3>
                </div>
                <div class="modal-body">
                    <p>Reopening an event should be considered a last resort option, and removes all records
                        of the event being closed to begin with.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" data-dismiss="modal" aria-hidden="true">Go Back</button>
                    <form class="form-inline" action="{% url 'events:reopen' event.id %}" method="post">
                        {% csrf_token %}
                        <button class="btn btn-primary" type="submit">Reopen Event</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% endpermission %}


    <div class="container-fluid">
        <div class="col-md-12">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#home" data-toggle="tab">Detail</a></li>
                <li><a href="#schedule" data-toggle="tab">Schedule</a></li>
                <li><a href="#services" data-toggle="tab">Services</a></li>
                <li><a href="#crew" data-toggle="tab">Crew</a></li>
                {% permission request.user has 'events.view_event_reports' of event %}
                    <li><a href="#reports" data-toggle="tab">Reports</a></li>
                {% endpermission %}
                {% permission request.user has 'events.view_event_billing' of event %}
                    <li><a href="#billing" data-toggle="tab">Billing</a></li>
                {% endpermission %}
                <li><a href="#files" data-toggle="tab">Files</a></li>
                {% permission request.user has 'events.view_posteventsurveyresults' of event.surveys.first %}
                    <li><a href="#survey" data-toggle="tab">Survey</a></li>
                {% endpermission %}
                {% if apps|length > 0 %}
                <li><a href="#apps" data-toggle="tab">Apps</a></li>
                {% endif %}
                <li><a href="#history" data-toggle="tab">History</a></li>
            </ul>

            <div class="tab-content">
                <div id="home" class="tab-pane active">
                    <table class="table">
                        <tr>
                            <th>Event Status</th>
                            <td>{{event.event_status}}</td>
                        </tr>
                        <tr>
                            <th>LNL Contact</th>
                            <td>
                                {% if event.lnl_contact %}
                                <a href="{% url "accounts:detail" event.lnl_contact.id %}">{{ event.lnl_contact.get_full_name }}</a>
                                {% else %}{{ event.lnl_contact }}{% endif %}
                            </td>
                        </tr>
                        <tr>
                            <th>Posted Description</th>
                            <td>{{ event.description|markdown }}</td>
                        </tr>
                        <tr>
                            <th>Event Contact Name</th>
                            <td>{% if event.contact %}
                                <a href="{% url "accounts:detail" event.contact.id %}">{{ event.contact.get_full_name }}</a>
                                {% else %}{{ event.contact }} {% endif %}</td>
                        </tr>
                        <tr>
                            <th>Event Contact Phone</th>
                            <td>{{ event.contact.phone }}</td>
                        </tr>
                        <tr>
                            <th>Event Contact Email</th>

                            <td><a href="mailto:{{ event.contact.email }}">{{ event.contact.email }}</a></td>

                        </tr>
                        <tr>
                            <th>Location</th>
                            <td>{{event.location}} <em>({{ event.location.building }})</em></td>
                        </tr>
                        <tr>
                            <th>Submitted by</th>
                            <td>
                                <a href="{% url "accounts:detail" event.submitted_by.id %}">{{ event.submitted_by.get_full_name }}</a>
                            </td>
                        </tr>
                        <tr>
                            <th>Submitted on</th>
                            <td>{{ event.submitted_on }} </td>
                        </tr>
                        {% permission request.user has 'events.event_view_granular' of event %}
                        <tr>
                            <th>Submitted from</th>
                            <td>{{event.submitted_ip}}</td>
                        </tr>
                        {% endpermission %}
                        {% if event.reference_code %}
                        <tr>
                            <th>25Live Reference Code</th>
                            <td>{{ event.reference_code }}</td>
                        </tr>
                        {% endif %}
                        <tr>
                            <th>Approved:</th>
                            <td>
                                {% if event.approved_by %}
                                    <a href="{% url "accounts:detail" event.approved_by.id %}">{{ event.approved_by.get_full_name }}</a>
                                    on {{ event.approved_on }}
                                {% else %}
                                    Needs Approval 
                                {% endif %}
                            </td>
                        </tr>
                        {% if event.cancelled %}
                        <tr>
                            <th>Cancelled:</th>
                            <td>
                                {% if event.cancelled_by %}
                                    <a href="{% url "accounts:detail" event.cancelled_by.id %}">{{ event.cancelled_by.get_full_name }}</a>
                                    on {{ event.cancelled_on }}
                                {% else %}
                                    True
                                {% endif %}
                            </td>
                        </tr>
                        {% permission request.user has 'events.event_view_sensitive' of event %}
                            <tr>   
                                <th>Cancellation Reason:</th>
                                <td>
                                    {% if event.cancelled_reason %}
                                        {{ event.cancelled_reason }}
                                    {% else %}
                                        None
                                    {% endif %}
                                </td>
                            </tr> 
                        {% endpermission %}
                        {% endif %}
                        {% if event.closed %}
                            <tr>
                                <th>Closed:</th>
                                <td>
                                    {% if event.closed_by %}
                                        <a href="{% url "accounts:detail" event.closed_by.id %}">{{ event.closed_by.get_full_name }}</a>
                                        on {{ event.closed_on }}
                                    {% else %}
                                        True
                                    {% endif %}
                                </td>
                            </tr>
                        {% endif %}
                        {% permission request.user has 'events.view_event_billing' of event %}
                            {% if event.reviewed %}
                                <tr>
                                    <th>Reviewed for billing:</th>
                                    <td>
                                        {% if event.reviewed_by %}
                                            <a href="{% url "accounts:detail" event.reviewed_by.id %}">{{ event.reviewed_by.get_full_name }}</a>
                                            on {{ event.reviewed_on }}
                                        {% else %}
                                            N/A
                                        {% endif %}
                                    </td>
                                </tr>
                            {% endif %}
                            <tr>
                                <th>Client to be billed</th>
                                <td> {{ event.org_to_be_billed }} </td>
                            </tr>
                            {% if event.worktag %}
                                <tr>
                                    <th>Worktag to be billed</th>
                                    <td>{{ event.worktag }} ({{ event.workday_fund }}-FD)</td>
                                </tr>
                            {% endif %}
                            {% if event.workday_entered_by %}
                                <tr>
                                    <th>Worktag entered by</th>
                                    <td><a href="{% url 'accounts:detail' event.workday_entered_by.id %}">{{ event.workday_entered_by.get_full_name }}</a></td>
                                </tr>
                            {% endif %}
                            <tr>
                                <th>Billed in bulk</th>
                                <td> {{ event.billed_in_bulk }} </td>
                            </tr>
                            {% if event.pricelist %}
                                <tr>
                                    <th>Pricelist</th>
                                    <td> {{ event.pricelist }} </td>
                                </tr>
                            {% endif %}
                        {% endpermission %}
                        {% permission request.user has 'events.view_posteventsurveyresults' of event.surveys.first %}
                            <tr>
                                <th>Survey</th>
                                <td>
                                    {% if event.survey_sent %}
                                        was sent
                                    {% elif event.send_survey %}
                                        will be sent
                                    {% else %}
                                        will not be sent
                                    {% endif %}
                                </td>
                            </tr>
                        {% endpermission %}
                        {% permission request.user has 'events.view_hidden_event' of event %}
                            {% if event.sensitive %}
                                <tr>
                                    <th>Sensitive and Hidden</th>
                                    <td> {{ event.sensitive }} </td>
                                </tr>
                            {% endif %}
                        {% endpermission %}
                        {% if event.test_event %}
                            <tr>
                                <th>Test Event</th>
                                <td> {{ event.test_event }} </td>
                            </tr>
                        {% endif %}
                        {% permission request.user has 'events.event_view_sensitive' of event %}
                            <tr>
                                <th>Internal Notes</th>
                                <td>{% if event.internal_notes %}
                                    {{ event.internal_notes | markdown }}{% else %}
                                    None {% endif %}</td>
                            </tr>
                        {% endpermission %}
                    </table>

                </div>
                <div id="schedule" class="tab-pane">
                    <table class="table">
                        {% now "U" as now__unix_time %}
                        {% for cc in event.ccinstances.all|dictsort:"setup_start" %}
                        <tr>
                            <th>Setup For {% if cc.service %}{{ cc.service }}{% else %}{{ cc.category }}{% endif %}</th>
                            <td>{{cc.setup_start|date:"D, N j Y, "}}<strong>{{cc.setup_start|date:"P"}}</strong>
                                {% if cc.setup_start|date:"U" >= now__unix_time %} <i style="float:inline-end">({{cc.setup_start|timeuntil}})</i></td> {% endif %}
                        </tr>
                        {% endfor %}
                        <tr>
                            <th>Setup Completion</th>
                            <td>{{event.datetime_setup_complete|date:"D, N j Y, "}}<strong>{{event.datetime_setup_complete|date:"P"}}</strong>
                                {% if event.datetime_setup_complete|date:"U" >= now__unix_time %} <i style="float:inline-end">({{event.datetime_setup_complete|timeuntil}})</i></td> {% endif %}
                        </tr>
                        <tr>
                            <th>Start</th>
                            <td>{{event.datetime_start|date:"D, N j Y, "}}<strong>{{event.datetime_start|date:"P"}}</strong>
                                {% if event.datetime_start|date:"U" >= now__unix_time %} <i style="float:inline-end">({{event.datetime_start|timeuntil}})</i></td> {% endif %}
                        </tr>
                        <tr>
                            <th>End</th>
                            <td>{{event.datetime_end|date:"D, N j Y, "}}<strong>{{event.datetime_end|date:"P"}}</strong>
                                {% if event.datetime_end|date:"U" >= now__unix_time %} <i style="float:inline-end">({{event.datetime_end|timeuntil}})</i></td> {% endif %}
                        </tr>
                    </table>
                </div>
                <div id="services" class="tab-pane">
                    {% if not event.closed %}
                        {% permission request.user has 'events.adjust_event_charges' of event %}
                            <div class="pull-right">
                                <a class="btn btn-lg btn-info" href="{% url "events:extras" event.id %}">Modify Extras</a>
                            </div>
                        {% endpermission %}
                    {% endif %}
                    {% if event.lighting %}
                        <h2>Lighting Services ({{ event.lighting }})</h2>
                        <h3>Requirements:</h3>
                        <div class="well">
                            {{ event.lighting_reqs | markdown }}
                        </div>
                        {% if event.extras_lighting %}
                        <h3>Extras:</h3>
                            <ul>
                                {% for e in event.extras_lighting %}
                                    <li>{{ e.extra }} x{{ e.quant }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endif %}
                    
                    {% if event.sound %}
                        <h2> Sound Services ({{ event.sound }})</h2>
                        <h3>Requirements:</h3>
                        <div class="well">
                            {{ event.sound_reqs | markdown }}
                        </div>
                        {% if event.extras_sound %}
                        <h3>Extras:</h3>
                            <ul>
                                {% for e in event.extras_sound %}
                                    <li>{{ e.extra }} x{{ e.quant }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endif %}
                    
                    {% if event.projection %}
                        <h2> Projection Services ({{ event.projection }})</h2>
                        <h3>Requirements:</h3>
                        <div class="well">
                            {{ event.proj_reqs | markdown }}
                        </div>
                        {% if event.extras_projection %}
                        <h3>Extras:</h3>
                            <ul>
                                {% for e in event.extras_projection %}
                                    <li>{{ e.extra }} x{{ e.quant }}</li>
                                {% endfor %}
                            </ul>
                        {% endif %}
                    {% endif %}
                    
                    {% if event.otherservices.exists %}
                        <h2> Other Services </h2>
                        <ul>
                            {% for s in event.otherservices.all %}
                                <li>{{ s }}</li>
                            {% endfor %}
                        </ul>
                        <h3>Requirements:</h3>
                        <div class="well">
                            {{ event.otherservice_reqs | markdown }}
                        </div>
                    {% endif %}
                    {% if event.extras_other %}
                        <h3>Additional Extras:</h3>
                            <ul>
                                {% for e in event.extras_other %}
                                    <li>{{ e.extra }} x{{ e.quant }}</li>
                                {% endfor %}
                            </ul>
                    {% endif %}
                    
                    {% if categorized_services_and_extras %}
                        {% for category_name, services_and_extras in categorized_services_and_extras.items %}
                            <h3>{{ category_name }}</h3>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Requirements</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for service_instance in services_and_extras.0 %}
                                        <tr>
                                            <td>{{ service_instance.service }}</td>
                                            <td>
                                                {% if service_instance.detail %}
                                                    {{ service_instance.detail | markdown }}
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            {% if services_and_extras.1 %}
                                <h4>Extras</h4>
                                <ul>
                                {% for extra_instance in services_and_extras.1 %}
                                    <li>{{ extra_instance.extra }} x{{ extra_instance.quant }}</li>
                                {% endfor %}
                                </ul>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                    
                </div>
                <div id="crew" class="tab-pane">
                    {% if not event.closed %}
                        {% permission request.user has 'events.edit_event_hours' of event %}
                            <a class="btn btn-lg btn-info pull-right" href="{% url "events:chiefs" event.id %}">Modify</a>
                        {% endpermission %}
                    {% endif %}
                    <h2> Crew Chief(s) </h2>
                    <table class="table">
                        <tr>
                            <th>Name</th>
                            <th>Setup Location</th>
                            <th>Setup Time</th>
                            <th>Category</th>
                        </tr>
                        {% for cc in event.ccinstances.all %}
                        <tr>
                            <td>
                                <a href="{% url "accounts:detail" cc.crew_chief.id %}">{{ cc.crew_chief.get_full_name }}</a>
                            </td>
                            <td>
                                {{ cc.setup_location }}
                            </td>
                            <td>
                                {{ cc.setup_start }}
                            </td>
                            <td>
                                {{ cc.category }}
                            </td>
                        {% endfor %}
                    </table>
                    {% if event.max_crew %}
                    <h3 class="h5">Maximum Crew Limit: {{ event.max_crew }}</h3>
                    <h3 class="h5">Current Crew Count: {{ crew_count }}</h3>
                    {% endif %}
                    {% comment %}
                    <a class="btn btn-lg btn-info pull-right" href="{% url "events:add-crew" event.id %}">Modify</a>
                    <h2> Crew </h2>
                    <ul>
                        {% for c in event.crew.all %}
                        <li><a href="{% url "memberdetail" c.id %}">{{ c }}</a></li>
                        {% endfor %}
                    </ul>
                    {% endcomment %}
                    
                </div>
                {% permission request.user has 'events.view_event_reports' of event %}
                <div id="reports" class="tab-pane">
                    {% if not event.closed %}
                        {% permission request.user has 'events.add_event_report' of event %}
                            <div class="pull-right">
                                <a class="btn btn-primary btn-lg" href="{% url "events:reports:new" event.id%}">New</a>
                            </div>
                        {% endpermission %}
                    {% endif %}
                    <h2>Reports</h2>
                    {% for report in event.ccreport_set.all %}
                        <h4>Report by {{report.crew_chief }}</h4> 
                        <em class="text-muted pull-right">
                            Posted on {{ report.created_on }} <br />
                            {% if report.created_on != report.updated_on %}
                                Last Updated: {{ report.updated_on }}
                            {% endif %}
                            {% if not event.closed %}
                                {% permission request.user has 'events.change_ccreport' of report %}
                                    [<a href="{% url "events:reports:edit" event.id report.id %}">Edit</a>]
                                {% endpermission %}
                                {% permission request.user has 'events.delete_ccreport' of report %}
                                    [<a href="{% url "events:reports:remove" event.id report.id %}">Delete</a>]
                                {% endpermission %}
                            {% endif %}
                        </em>
                        
                        <blockquote>
                            {{ report.report|markdown }}
                            {% comment %} <small>For {{ report.pretty_cat_list }}</small>{% endcomment %}
                        </blockquote> 
                        
                    {% empty %}
                        <h3>No Reports Submitted </h3>
                    {% endfor %}
                    {% if event.crew_needing_reports %}
                        <h4> Crew Chiefs Needing Reports </h4>
                        {% permission request.user has 'events.review_event' %}
                        <a class="btn btn-info btn-default btn-xs" href="{% url 'events:remindall' id=event.id %}">Remind All</a>
                        <br><br>
                        {% endpermission %}
                        <ul>
                        {% for crew in event.crew_needing_reports %}
                            <li>
                                <a href="{% url "accounts:detail" crew.crew_chief.id %}">{{ crew.crew_chief }}</a>
                            </li>
                        {% endfor %}
                        </ul>
                    {% endif %}
                    {% if not event.closed %}
                        {% permission request.user has 'events.edit_event_hours' of event %}
                            <div class="pull-right">
                                <a class="btn btn-primary btn-lg" href="{% url 'events:add-bulk-crew' event.id %}">Edit</a>
                            </div>
                        {% endpermission %}
                    {% endif %}
                    <h2> Hours </h2>
                    <table class="table">
                        <thead>
                        <tr>
                            <th>Member</th>
                            <th>Hours</th>
                            <th>Category</th>
                        </tr>
                        </thead>
                        {% for hour in event.hours.all %}
                            <tr>
                                <td><a href="{% url "accounts:detail" hour.user.id %}">{{ hour.user.get_full_name }}</a>
                                </td>
                                <td>
                                        {% if hour.hours is None %}
                                            Pending
                                        {% else %}
                                            {{ hour.hours }}
                                        {% endif %}
                                </td>
                                <td>{{ hour.category }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
                {% endpermission %}
                {% permission request.user has 'events.view_event_billing' of event %}
                <div id="billing" class="tab-pane">
                    {% if not event.closed %}
                        {% permission request.user has 'events.adjust_event_charges' of event %}
                            <div class="pull-right btn-group">
                                <a class="btn btn-lg btn-primary" href="{% url "events:extras" event.id %}">Modify Extras</a>
                                <a class="btn btn-lg btn-info" href="{% url "events:oneoffs" event.id %}">Add OneOff
                                    Charges</a>
                            </div>
                        {% endpermission %}
                    {% endif %}
                    <h2>Price Breakdown</h2>
                    {% if event.worktag %}
                        <h3>Charge from {{ event.worktag }}</h3>
                    {% endif %}
                    {% if event.late %}
                        <div class="alert alert-warning" role="alert">
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
                            <b>Late Booked Event:</b>
                            This event was booked {{ event.submitted_on|timesince:event.datetime_setup_complete }}
                            before it began.
                        </div>
                    {% endif %}
                    {% if not event.approved %}
                        <p style="color:red;">
                            This is NOT a quote. Until you have received an email saying that the event is approved (which you haven't),
                            the information on this page reflects the information entered into the website by the client and has not been reviewed by Lens and Lights for accuracy.
                        </p>
                    {% endif %}
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Cost</th>
                            </tr>
                        </thead>
                        {% if event.lighting %}
                        <tr class="success">
                            <td>{{event.lighting}}</td>
                            <td class="tdra">${{ event.lighting.base_cost }}</td>
                        </tr>
                        {% endif %}
                        {% if event.extras_lighting.exists %}
                        {% for extra in event.extras_lighting %}
                        <tr>
                            <td>{{ extra.extra }} <strong>x{{extra.quant}} </strong></td>
                            <td class="tdra">${{ extra.totalcost }}</td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                        
                        {% if event.sound %}
                        <tr class="success">
                            <td>{{event.sound}}</td>
                            <td class="tdra">${{ event.sound.base_cost }}</td>
                        </tr>
                        {% endif %}
                        {% if event.extras_sound.exists %}
                        {% for extra in event.extras_sound %}
                        <tr>
                            <td>{{ extra.extra }} <strong>x{{extra.quant}} </strong></td>
                            <td class="tdra">${{ extra.totalcost }}</td>
                        </tr>
                        {% endfor %}
                        {% endif %}
                        
                        {% if event.projection %}
                        <tr class="success">
                            <td>{{event.projection}}</td>
                            <td class="tdra">${{ event.projection.base_cost }}</td>
                        </tr>
                        {% endif %}

                        {% for extra in event.extras_projection %}
                        <tr>
                            <td>{{ extra.extra }} <strong>x{{extra.quant}} </strong></td>
                            <td class="tdra">${{ extra.totalcost }}</td>
                        </tr>
                        {% endfor %}

                        {% if event.otherservices.exists %}
                            {% for service in event.otherservices.all %}
                                <tr class="success">
                                    <td>{{ service }}</td>
                                    <td class="tdra">${{ service.base_cost }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}
                        
                        {% for e in event.extras_other %}
                        <tr>
                            <td>{{ e.extra }} <strong>x{{ e.quant }}</strong></td>
                            <td class="tdra">${{ e.totalcost }}</td>
                        </tr>
                        {% endfor %}
                        
                        {% if event.serviceinstance_set.exists %}
                            {% for service_instance in event.serviceinstance_set.all %}
                                <tr>
                                    <td>{{ service_instance.service }}</td>
                                    <td class="tdra">${{ service_instance.cost }}</td>
                                </tr>
                            {% endfor %}
                            {% for extra_instance in event.extrainstance_set.all %}
                                <tr>
                                    <td>{{ extra_instance.extra }} <strong>x{{ extra_instance.quant }}</strong></td>
                                    <td class="tdra">${{ extra_instance.totalcost }}</td>
                                </tr>
                            {% endfor %}
                        {% endif %}

                        {% for oo in event.oneoffs %}
                        <tr>
                            <td>{{ oo.key_name }} ({{ oo.key_value }}) <strong>x{{ oo.key_quantity }}</strong></td>
                            <td {% if oo.negative %} style="color:red;" {% endif %} class="tdra">
                                {% if oo.negative %}-{% endif %}${{ oo.abs_cost }}
                            </td>
                        </tr>
                        {% endfor %}
                        
                        {% if event.discount_applied %}
                        <tr class="warning">
                            <td> Pre Discount Total </td>
                            <td class="tdra">${{ event.cost_total_pre_discount }} </td>
                        </tr>
                        <tr class="warning">
                            <td>Lighting/Sound Combo Discount Applied</td>
                            <td style="color:red;" class="tdra">-${{ event.discount_value|floatformat:2}}</td>
                        </tr>
                        {% endif %}
                        
                        <tr class="info">
                            <td>Total</td>
                            <td>${{ event.cost_total|floatformat:2 }}</td>
                        </tr>
                    </table>
                    {% if not event.approved %}
                        <p style="color:red;">
                            This is NOT a quote. Until you have received an email saying that the event is approved (which you haven't),
                            the information on this page reflects the information entered into the website by the client and has not been reviewed by Lens and Lights for accuracy.
                        </p>
                    {% endif %}
                    <h2> Bills </h2>
                    {% if event.reviewed %}
                        <a class="btn btn-primary" href="{% url "events:bills:pdf" event.id %}">Download Invoice</a>
                    {% elif event.approved %}
                        <a class="btn btn-primary" href="{% url "events:bills:pdf" event.id %}">Download Quote</a>
                    {% else %}
                        {% permission request.user has 'events.bill_event' of event %}
                            <a class="btn btn-primary" href="{% url "events:bills:pdf" event.id %}">Download Quote</a>
                        {% endpermission %}
                    {% endif %}
                    {% if event.billings or event.multibillings %}
                        <table class="table">
                            <thead>
                            <tr>
                                <th>Date Billed</th>
                                <th>Date Paid</th>
                                <th>Amount</th>
                                {% permission request.user has 'events.bill_event' of event %}
                                    <th>Email Sent</th>
                                    <th>&nbsp;</th>
                                {% endpermission %}
                            </tr>
                            </thead>
                            {% for billing in event.billings.all %}
                                <tr>
                                    <td>{{ billing.date_billed }}</td>
                                    <td>{{ billing.date_paid }}</td>
                                    <td>{{ billing.amount }}</td>
                                    {% permission request.user has 'events.bill_event' of event %}
                                        <td>
                                            {% for email in billing.billingemail_set.all %}
                                                {% if email.sent_at %}
                                                    {{ email.sent_at }}<br>
                                                {% else %}
                                                    <span class="glyphicon glyphicon-exclamation-sign" title="This shouldn't happen!"></span> Never<br>
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% if not event.closed %}
                                                <form class="form-inline" action="{% url "events:bills:pay" event.id billing.id %}" method="post">
                                                    <div class="form-group">
                                                    {% if not billing.date_paid %}
                                                        {% csrf_token %}
                                                        <button class="btn btn-link" type="submit">Mark Paid</button>
                                                    {% endif %}
                                                    <a class="btn btn-link"
                                                       href="{% url "events:bills:edit" event.id billing.id %}">Update</a>
                                                    {% if not billing.date_paid %}
                                                        <a class="btn btn-link" href="{% url "events:bills:remove" event.id billing.id %}">Delete</a>
                                                    {% endif %}
                                                    </div>
                                                </form>
                                            {% endif %}
                                        </td>
                                    {% endpermission %}
                                </tr>
                            {% endfor %}
                            {% for multibilling in event.multibillings.all %}
                                <tr>
                                    <td>{{ multibilling.date_billed }}</td>
                                    <td>{{ multibilling.date_paid }}</td>
                                    <td><a href="{% url 'events:multibillings:pdf' multibilling.id %}">See invoice</a></td>
                                    {% permission request.user has 'events.bill_event' of event %}
                                        <td>
                                            {% for email in multibilling.multibillingemail_set.all %}
                                                {% if email.sent_at %}
                                                    {{ email.sent_at }}<br>
                                                {% else %}
                                                    <span class="glyphicon glyphicon-exclamation-sign" title="This shouldn't happen!"></span> Never<br>
                                                {% endif %}
                                            {% endfor %}
                                        </td>
                                        <td>
                                            MultiBill
                                        </td>
                                    {% endpermission %}
                                </tr>
                            {% endfor %}
                        </table>
                    {% else %}
                        <h2> No Bills Posted </h2>
                    {% endif %}

                    {% permission request.user has 'events.event_view_sensitive' of event %}
                        <h3>Internal Notes</h3>
                        <p>{% if event.internal_notes %}
                            {{ event.internal_notes|markdown }}{% else %} None {% endif %}</p>
                    {% endpermission %}
                </div>
                {% endpermission %}
                <div id="files" class="tab-pane">
                    {% if not event.closed %}
                        {% permission request.user has 'events.event_attachments' of event %}
                            <div class="pull-right">
                                <a class="btn btn-warning" href="{% url "events:files" event.id %}">Edit</a>
                            </div>
                        {% endpermission %}
                    {% endif %}
                    <h2> Files </h2> 
                    <table class="table">
                        <tr>
                            <th>Service</th>
                            <th>Notes</th>
                            <th>File Name</th>
                            <th>Client Upload?</th>
                            <th></th>
                        </tr>
                        {% for a in event.attachments.all %}
                        <tr>
                            <td>
                                {% for s in a.for_service.all %}
                                {{ s }}{% if not forloop.last %},{% endif %}
                                {% empty %}
                                {% endfor %}
                            </td>
                            <td>{{ a.note }}</td>
                            <td>{{ a.attachment.name }}</td>
                            <td>{{ a.externally_uploaded }} </td>
                            <td><a class="btn btn-primary" href="{{ a.attachment.url }}">Link</a></td>
                        </tr>
                        
                        
                        {% empty %}
                        <tr><td colspan="4">No files have been uploaded</td></tr>
                        {% endfor %}
                    </table>
                </div>
                {% permission request.user has 'events.view_posteventsurveyresults' of event.surveys.first %}
                <div id="survey" class="tab-pane">
                    <h2>Survey results</h2>
                    {% if survey_results %}
                        <h4>Composite results</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>VP</th>
                                    <th>Crew</th>
                                    <!--<th>Pricelist</th>-->
                                    <th>LNL</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr style="font-size: 3em">
                                    <td style="color: {{ survey_composites.vp|gpa_scale_color }}">
                                        {{ survey_composites.vp|gpa_scale_clean }}</td>
                                    <td style="color: {{ survey_composites.crew|gpa_scale_color }}">
                                        {{ survey_composites.crew|gpa_scale_clean }}</td>
                                    <!--<td style="color: {{ survey_composites.pricelist|gpa_scale_color }}">
                                        {{ survey_composites.pricelist|gpa_scale_clean }}</td>-->
                                    <td style="color: {{ survey_composites.overall|gpa_scale_color }}">
                                        {{ survey_composites.overall|gpa_scale_clean }}</td>
                                </tr>
                            </tbody>
                        </table>
                        <h4>People who have taken the survey</h4>
                        <p>{% for person in survey_takers %}<a href="{% url 'accounts:detail' person.id %}">{{ person }}</a>{% if not forloop.last %}, {% endif %}{% endfor %}</p>
                        <h4>How did you submit the workorder?</h4>
                        <p>{% for method in survey_workorder_methods %}{{ method }}{% if not forloop.last %}, {% endif %}{% empty %}Nobody answered this question.{% endfor %}</p>
                        <h4>Workorder Comments</h4>
                        {% for c in survey_workorder_comments %}<p>{{ c }}</p>{% empty %}Nobody answered this question{% endfor %}
                        <br><br>
                        <h4>Rating questions</h4>
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Question</th>
                                    <th>Average (4.0 scale)</th>
                                    <th>Count</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>{{ survey_results.services_quality__verbose_name }}</td>
                                    <td>{{ survey_results.services_quality__avg }}</td>
                                    <td>{{ survey_results.services_quality__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.lighting_quality__verbose_name }}</td>
                                    <td>{{ survey_results.lighting_quality__avg }}</td>
                                    <td>{{ survey_results.lighting_quality__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.sound_quality__verbose_name }}</td>
                                    <td>{{ survey_results.sound_quality__avg }}</td>
                                    <td>{{ survey_results.sound_quality__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.work_order_experience__verbose_name }}</td>
                                    <td>{{ survey_results.work_order_experience__avg }}</td>
                                    <td>{{ survey_results.work_order_experience__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.work_order_ease__verbose_name }}</td>
                                    <td>{{ survey_results.work_order_ease__avg }}</td>
                                    <td>{{ survey_results.work_order_ease__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.communication_responsiveness__verbose_name }}</td>
                                    <td>{{ survey_results.communication_responsiveness__avg }}</td>
                                    <td>{{ survey_results.communication_responsiveness__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.pricelist_ux__verbose_name }}</td>
                                    <td>{{ survey_results.pricelist_ux__avg }}</td>
                                    <td>{{ survey_results.pricelist_ux__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.setup_on_time__verbose_name }}</td>
                                    <td>{{ survey_results.setup_on_time__avg }}</td>
                                    <td>{{ survey_results.setup_on_time__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.crew_respectfulness__verbose_name }}</td>
                                    <td>{{ survey_results.crew_respectfulness__avg }}</td>
                                    <td>{{ survey_results.crew_respectfulness__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.price_appropriate__verbose_name }}</td>
                                    <td>{{ survey_results.price_appropriate__avg }}</td>
                                    <td>{{ survey_results.price_appropriate__count }}</td>
                                </tr>
                                <tr>
                                    <td>{{ survey_results.customer_would_return__verbose_name }}</td>
                                    <td>{{ survey_results.customer_would_return__avg }}</td>
                                    <td>{{ survey_results.customer_would_return__count }}</td>
                                </tr>
                            </tbody>
                        </table>
                        <h4>Please use this area to explain low ratings above or to provide any other feedback you have. We value your feedback and will use it to improve our services.</h4>
                        {% for c in survey_comments %}<p>{{ c }}</p>{% empty %}Nobody answered this question.{% endfor %}
                    {% else %}
                        Nobody has taken the survey.
                    {% endif %}
                </div>
                {% endpermission %}
                {% if apps|length > 0 %}
                <div id="apps" class="tab-pane">
                    <h2> Third-party Integrations </h2>
                    <br>
                    <div class="row">
                        <div class="col-md-6">
                            {% if "spotify" in apps %}
                            <div class="panel panel-default">
                                <div class="panel-heading">
                                    <h3 class="h4" style="margin-top: 0; margin-bottom: 0">Spotify</h3>
                                </div>
                                <div class="panel-body" style="overflow-wrap: break-word">
                                    {% if event.session_set.first %}
                                        {% if not event.reviewed and not event.cancelled and not event.closed %}
                                            <h4>Current Session</h4>
                                            <p>Request songs at: <a href="{% url 'spotify:request' event.session_set.first.slug %}">
                                                {{ request.scheme }}://{{ request.get_host }}{% url 'spotify:request' event.session_set.first.slug %}</a>
                                            </p>
                                            {% permission request.user has 'spotify.change_session' of event.session_set.first %}
                                            <ul>
                                                <li><strong>Account:</strong> {{ event.session_set.first.user }}</li>
                                                <li><strong>Accepting requests:</strong> {{ event.session_set.first.accepting_requests|yesno|capfirst }}</li>
                                                <li><strong>Allow explicit music:</strong> {{ event.session_set.first.allow_explicit|yesno|capfirst }}</li>
                                                <li><strong>Payment required:</strong> {{ event.session_set.first.require_payment|yesno|capfirst }}</li>
                                            </ul>
                                            <br>
                                            <a href="{% url 'spotify:event-session' event.pk %}" class="btn btn-default">Configure Session</a>
                                            <a href="{% url 'spotify:list' event.session_set.first.pk %}" class="btn btn-default">Manage Requests</a>
                                            <a href="{% url 'spotify:qr' event.session_set.first.pk %}" class="btn btn-default">QR Code</a>
                                            {% elpermission request.user has 'spotify.view_session' of event.session_set.first %}
                                            <div class="col-md-3" style="cursor: pointer"
                                                 onclick="window.location.href = '{% url 'spotify:qr' event.session_set.first.pk %}';">
                                                {% qr_code event.session_set.first %}
                                            </div>
                                            {% endpermission %}
                                        {% else %}
                                            <h4>Session Closed</h4>
                                            <p>Song requests can no longer be submitted for this event. To view a list
                                                of content played during the event, click the button below.</p>
                                            <br>
                                            <a href="{% url 'spotify:list' event.session_set.first.pk %}" class="btn btn-success">View History</a>
                                        {% endif %}
                                    {% else %}
                                        <p>Start a new session to begin collecting song requests.</p>
                                        <a href="{% url 'spotify:event-session' event.pk %}" class="btn btn-success">New Session</a>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                <div id="history" class="tab-pane">
                    <h2> History </h2>
                    <table class="table">
                        <tr>
                            <th>Date</th>
                            <th>User</th>
                            <th>Comment</th>
                        </tr>
                        {% for version in history %}
                            <tr>
                                <td>
                                    {{ version.revision.date_created }}
                                </td>
                                <td>
                                    {% if version.revision.user %}
                                        {{ version.revision.user }}
                                    {% else %}
                                        [None]
                                    {% endif %}
                                </td>
                                <td>{{ version.revision.comment }}</td>
                            </tr>
                        {% endfor %}
                    </table>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
